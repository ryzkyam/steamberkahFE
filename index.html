<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BERKAH STEAM MOTOR - Dashboard</title>

    <script>
      if (!localStorage.getItem("username")) {
        window.location.href = "login.html";
      }
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #1e3a8a;
        --accent: #3b82f6;
        --light-bg: #f3f4f6;
        --sidebar-width: 260px;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--light-bg);
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      /* SIDEBAR DESKTOP */
      .sidebar {
        width: var(--sidebar-width);
        background: var(--primary);
        color: #fff;
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        padding: 25px 20px;
        z-index: 1000;
      }

      .sidebar h2 {
        font-size: 1.4rem;
        font-weight: 800;
        margin-bottom: 30px;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 15px;
      }

      .sidebar-links a {
        color: #dbeafe;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        border-radius: 12px;
        transition: 0.2s;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .sidebar-links a:hover,
      .sidebar-links a.active {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }

      .sidebar-links a.active {
        background: var(--accent) !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      /* MAIN CONTENT */
      .main {
        margin-left: var(--sidebar-width);
        flex: 1;
        padding: 30px;
        transition: 0.3s;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      /* CARDS */
      .summary-card {
        border-radius: 1.25rem;
        padding: 25px;
        color: #fff;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        transition: 0.3s;
        border: none;
        height: 100%;
      }

      .summary-card:hover {
        transform: translateY(-5px);
      }
      .summary-card.motor {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
      }
      .summary-card.pendapatan {
        background: linear-gradient(135deg, #10b981, #065f46);
      }
      .summary-card.pengeluaran {
        background: linear-gradient(135deg, #ef4444, #991b1b);
      }
      .summary-card.saldo {
        background: linear-gradient(135deg, #f59e0b, #b45309);
      }

      /* RESPONSIVE */
      @media (max-width: 992px) {
        .sidebar {
          display: none;
        }
        .main {
          margin-left: 0;
          padding: 20px;
        }
      }

      /* OFFCANVAS MOBILE */
      .offcanvas {
        background: var(--primary);
        color: white;
        width: 280px !important;
      }
      .offcanvas-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg d-lg-none bg-white shadow-sm p-3">
      <div class="container-fluid">
        <button
          class="btn btn-primary"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mobileMenu"
        >
          <i class="bi bi-list"></i> Menu
        </button>
        <span class="fw-bold text-primary">STEAM BERKAH</span>
      </div>
    </nav>

    <div class="sidebar">
      <h2>STEAM BERKAHH</h2>
      <div class="sidebar-links">
        <a href="index.html" class="active"
          ><i class="bi bi-speedometer2"></i> Dashboard</a
        >
        <a href="Transaksi.html"><i class="bi bi-cash-stack"></i> Transaksi</a>
        <a href="tabelPengeluaran.html"
          ><i class="bi bi-wallet2"></i> Pengeluaran</a
        >
        <a href="stockBarang.html"
          ><i class="bi bi-box-chart-line"></i> Stok Barang</a
        >
        <a href="karyawan.html"><i class="bi bi-people"></i> Karyawan</a>
        <a href="perhari.html"
          ><i class="bi bi-info-circle"></i> Transaksi Hari Ini</a
        >
        <hr style="opacity: 0.1" />
        <a href="#" id="logoutBtn" class="text-danger"
          ><i class="bi bi-box-arrow-right"></i> Logout</a
        >
      </div>
      <div class="mt-auto p-2 text-center small opacity-50" id="userDisplay">
        Admin: -
      </div>
    </div>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title fw-bold">STEAM BERKAH</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="sidebar-links">
          <a href="index.html" class="active"
            ><i class="bi bi-speedometer2"></i> Dashboard</a
          >
          <a href="Transaksi.html"
            ><i class="bi bi-cash-stack"></i> Transaksi</a
          >
          <a href="tabelPengeluaran.html"
            ><i class="bi bi-wallet2"></i> Pengeluaran</a
          >
          <a href="stockBarang.html"
            ><i class="bi bi-box-chart-line"></i> Stok Barang</a
          >
          <a href="karyawan.html"><i class="bi bi-people"></i> Karyawan</a>
          <a href="perhari.html"
            ><i class="bi bi-info-circle"></i> Transaksi Hari Ini</a
          >
          <a href="#" class="text-danger logoutAction"
            ><i class="bi bi-box-arrow-right"></i> Logout</a
          >
        </div>
      </div>
    </div>

    <div class="main">
      <div id="alertPlaceholder"></div>

      <div class="topbar">
        <div>
          <h1 class="fw-bold mb-0">Laporan Real-time</h1>
          <p class="text-muted">Data otomatis di-push oleh Robot UiPath</p>
        </div>
        <button id="refreshBtn" class="btn btn-primary px-4">
          <i class="bi bi-arrow-clockwise me-2"></i>Refresh
        </button>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="summary-card motor">
            <h6>Total Unit Motor</h6>
            <h2 id="totalMotor">0</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="summary-card pendapatan">
            <h6>Kotor (100%)</h6>
            <h2 id="totalPendapatan">Rp 0</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="summary-card pengeluaran">
            <h6>Gaji Operator (40%)</h6>
            <h2 id="totalPengeluaran">Rp 0</h2>
          </div>
        </div>
        <div class="col-md-3">
          <div class="summary-card saldo">
            <h6>Bersih Owner (60%)</h6>
            <h2 id="saldoBersih">Rp 0</h2>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-table me-2 text-primary"></i>Rincian Transaksi
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-4">Operator</th>
                  <th>Kategori</th>
                  <th>Layanan</th>
                  <th>Waktu</th>
                  <th class="text-end pe-4">Total</th>
                </tr>
              </thead>
              <tbody id="dataTable">
                <tr>
                  <td colspan="5" class="text-center py-5 text-muted">
                    Klik Refresh untuk memuat data...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Tampilkan User di Sidebar
      document.getElementById("userDisplay").innerText =
        "Admin: " + localStorage.getItem("username");

      // Helper Alert Bootstrap
      function showAlert(message, type) {
        const wrapper = document.createElement("div");
        wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        document.getElementById("alertPlaceholder").append(wrapper);
        setTimeout(() => wrapper.remove(), 3000);
      }

      async function fetchTransaksi() {
        const tbody = document.getElementById("dataTable");
        try {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center py-4">Menghubungkan ke SQL Server...</td></tr>';

          const res = await fetch("http://localhost:5000/api/transaksi");
          if (!res.ok) throw new Error("Gagal ambil data");

          const data = await res.json();
          tbody.innerHTML = "";

          let kotor = 0;
          let motorCount = 0;

          data.forEach((item) => {
            kotor += item.total || 0;
            motorCount++;
            const tr = document.createElement("tr");
            tr.innerHTML = `
                        <td class="ps-4 fw-bold">${
                          item.karyawanTerkait?.nama || "Umum"
                        }</td>
                        <td><span class="badge bg-light text-dark border">${
                          item.motorTerkait?.kategori || "-"
                        }</span></td>
                        <td>${item.layanan}</td>
                        <td class="small text-muted">${new Date(
                          item.tanggal
                        ).toLocaleString("id-ID")}</td>
                        <td class="text-end pe-4 fw-bold text-primary">Rp ${item.total.toLocaleString(
                          "id-ID"
                        )}</td>
                    `;
            tbody.appendChild(tr);
          });

          // Update Dashboard Numbers
          document.getElementById("totalMotor").innerText = motorCount;
          document.getElementById(
            "totalPendapatan"
          ).innerText = `Rp ${kotor.toLocaleString("id-ID")}`;
          document.getElementById("totalPengeluaran").innerText = `Rp ${(
            kotor * 0.4
          ).toLocaleString("id-ID")}`;
          document.getElementById("saldoBersih").innerText = `Rp ${(
            kotor * 0.6
          ).toLocaleString("id-ID")}`;

          showAlert("Data diperbarui!", "success");
        } catch (err) {
          showAlert("Server Backend (.NET) belum jalan!", "danger");
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-danger py-4">Error: Koneksi Gagal</td></tr>';
        }
      }

      // Logout Logic
      const logoutFunc = (e) => {
        e.preventDefault();
        localStorage.clear();
        window.location.href = "login.html";
      };

      document
        .getElementById("logoutBtn")
        .addEventListener("click", logoutFunc);
      document
        .querySelectorAll(".logoutAction")
        .forEach((btn) => btn.addEventListener("click", logoutFunc));
      document
        .getElementById("refreshBtn")
        .addEventListener("click", fetchTransaksi);

      // Auto Load
      fetchTransaksi();
    </script>
  </body>
</html>
