<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaksi Hari Ini - STEAM BERKAH</title>

    <script>
      if (!localStorage.getItem("username")) {
        window.location.href = "login.html";
      }
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #1e3a8a;
        --accent: #3b82f6;
        --light-bg: #f3f4f6;
        --sidebar-width: 260px;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--light-bg);
        margin: 0;
        display: flex;
      }

      /* SIDEBAR DESKTOP */
      .sidebar {
        width: var(--sidebar-width);
        background: var(--primary);
        color: #fff;
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        padding: 25px 20px;
        z-index: 1000;
      }

      .sidebar h2 {
        font-size: 1.4rem;
        font-weight: 800;
        margin-bottom: 30px;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 15px;
      }

      .sidebar-links a {
        color: #dbeafe;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        border-radius: 12px;
        transition: 0.2s;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .sidebar-links a:hover,
      .sidebar-links a.active {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }

      .sidebar-links a.active {
        background: var(--accent) !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      /* MAIN CONTENT */
      .main {
        margin-left: var(--sidebar-width);
        flex: 1;
        padding: 30px;
        transition: 0.3s;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      /* CARDS RINGKASAN */
      .summary-card {
        border-radius: 1.25rem;
        padding: 25px;
        color: #fff;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        border: none;
      }
      .summary-card.pendapatan {
        background: linear-gradient(135deg, #10b981, #065f46);
      }
      .summary-card.owner {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
      }
      .summary-card.karyawan {
        background: linear-gradient(135deg, #f59e0b, #b45309);
      }

      /* RESPONSIVE */
      @media (max-width: 992px) {
        .sidebar {
          display: none;
        }
        .main {
          margin-left: 0;
          padding: 20px;
        }
      }

      .offcanvas {
        background: var(--primary);
        color: white;
        width: 280px !important;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg d-lg-none bg-white shadow-sm p-3 w-100 position-fixed top-0 z-3"
    >
      <div class="container-fluid">
        <button
          class="btn btn-primary"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mobileMenu"
        >
          <i class="bi bi-list"></i>
        </button>
        <span class="fw-bold text-primary">STEAM BERKAH</span>
      </div>
    </nav>

    <div class="sidebar d-none d-lg-flex">
      <h2>STEAM BERKAH</h2>
      <div class="sidebar-links">
        <a href="index.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="jasaperkaryawan.html" class="active"
          ><i class="bi bi-person-badge"></i> Jasa Karyawan</a
        >
        <a href="tabelPengeluaran.html"
          ><i class="bi bi-wallet2"></i> Pengeluaran</a
        >
        <a href="TransaksiPengeluaran.html"
          ><i class="bi bi-plus-circle"></i> Buat Pengeluaran</a
        >
        <hr style="opacity: 0.1" />
        <a href="#" class="text-danger logoutAction"
          ><i class="bi bi-box-arrow-right"></i> Logout</a
        >
      </div>
    </div>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu">
      <div class="offcanvas-header border-bottom border-secondary">
        <h5 class="offcanvas-title fw-bold">STEAM BERKAH</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="sidebar-links">
          <a href="index.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
          <a href="jasaperkaryawan.html" class="active"
            ><i class="bi bi-person-badge"></i> Jasa Karyawan</a
          >
          <a href="#" class="text-danger logoutAction"
            ><i class="bi bi-box-arrow-right"></i> Logout</a
          >
        </div>
      </div>
    </div>

    <div class="main mt-5 mt-lg-0">
      <div class="topbar">
        <div>
          <h1 class="fw-bold mb-0">Laporan Per Karyawan</h1>
          <p class="text-muted" id="currentDateDisplay">Memuat tanggal...</p>
        </div>
        <button id="refreshBtn" class="btn btn-primary px-4 shadow-sm">
          <i class="bi bi-arrow-clockwise me-2"></i>Refresh Data
        </button>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-md-4">
          <div class="summary-card pendapatan">
            <h6>Total Omzet Hari Ini</h6>
            <h2 id="totalPendapatan">Rp 0</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="summary-card owner">
            <h6>Bagian Owner (60%)</h6>
            <h2 id="ownerShare">Rp 0</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="summary-card karyawan">
            <h6>Total Jasa Karyawan (40%)</h6>
            <h2 id="karyawanShare">Rp 0</h2>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 border-0">
          <h5 class="mb-0 fw-bold">
            <i class="bi bi-people-fill me-2 text-primary"></i>Rincian Pembagian
            Jasa
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-4">Nama Karyawan</th>
                  <th>Unit Motor</th>
                  <th>Omzet Bruto</th>
                  <th class="text-end pe-4">Upah (40%)</th>
                </tr>
              </thead>
              <tbody id="tabelKaryawan">
                <tr>
                  <td colspan="4" class="text-center py-5">Memuat data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>
<script>
    const BASE_URL = window.CONFIG ? window.CONFIG.API_BASE_URL : "http://localhost:5127/api";

    async function loadData() {
        const tabel = document.getElementById("tabelKaryawan");
        const dateDisplay = document.getElementById("currentDateDisplay");

        // 1. Setup Tanggal
        const sekarang = new Date();
        const opsi = { weekday: "long", year: "numeric", month: "long", day: "numeric" };
        dateDisplay.innerText = sekarang.toLocaleDateString("id-ID", opsi);

        // Ambil string tanggal format YYYY-MM-DD sesuai waktu lokal
        const todayStr = sekarang.toLocaleDateString("en-CA");

        try {
            tabel.innerHTML = '<tr><td colspan="4" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

            // 2. Fetch Data Transaksi
            const res = await fetch(`${BASE_URL}/transaksi`);
            if (!res.ok) throw new Error("Gagal konek server");
            const data = await res.json();

            // 3. Logic Filter Hari Ini
            const todayData = data.filter((t) => {
                if (!t.tanggal) return false;
                const tglTransaksi = new Date(t.tanggal).toLocaleDateString("en-CA");
                return tglTransaksi === todayStr;
            });

            let totalOmzet = 0;
            const grouped = {};

            // 4. Kalkulasi Bagi Hasil (Gaji Karyawan)
            todayData.forEach((t) => {
                const nominal = t.total || 0;
                totalOmzet += nominal;
                const nama = t.karyawanTerkait?.nama || "Umum";

                if (!grouped[nama]) grouped[nama] = { unit: 0, omzet: 0 };
                grouped[nama].unit++;
                grouped[nama].omzet += nominal;
            });

            if (todayData.length === 0) {
                tabel.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-muted">Belum ada transaksi masuk hari ini (${todayStr}).</td></tr>`;
            } else {
                tabel.innerHTML = Object.entries(grouped)
                    .map(([nama, v]) => `
                        <tr>
                            <td class="ps-4 fw-bold text-dark">${nama}</td>
                            <td><span class="badge bg-primary-subtle text-primary border border-primary-subtle">${v.unit} Motor</span></td>
                            <td>Rp ${v.omzet.toLocaleString("id-ID")}</td>
                            <td class="text-end pe-4 fw-bold text-success">Rp ${(v.omzet * 0.4).toLocaleString("id-ID")}</td>
                        </tr>
                    `).join("");
            }

            // 5. Update UI Cards (Summary)
            document.getElementById("totalPendapatan").innerText = `Rp ${totalOmzet.toLocaleString("id-ID")}`;
            document.getElementById("ownerShare").innerText = `Rp ${(totalOmzet * 0.6).toLocaleString("id-ID")}`;
            document.getElementById("karyawanShare").innerText = `Rp ${(totalOmzet * 0.4).toLocaleString("id-ID")}`;

        } catch (err) {
            console.error(err);
            tabel.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-danger">Gagal memuat data API: ${BASE_URL}</td></tr>`;
        }
    }

    loadData();
</script>
  </body>
</html>
