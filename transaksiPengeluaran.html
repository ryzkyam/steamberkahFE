<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail & Tambah Pengeluaran - REAZ STEAM MOTOR</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #1e3a8a;
        --secondary-color: #f9fafb;
        --accent-color: #3b82f6;
        --success-color: #16a34a;
        --danger-color: #dc2626;
        --warning-color: #f59e0b;
        --card-bg: #ffffff;
        --text-dark: #111827;
        --text-light: #f3f4f6;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--secondary-color);
        color: var(--text-dark);
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-weight: 600;
      }
      .container {
        max-width: 1400px;
        padding-top: 40px;
        padding-bottom: 40px;
      }
      .card {
        background-color: var(--card-bg);
        border: none;
        border-radius: 1.25rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s, box-shadow 0.3s;
      }
      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.12);
      }
      .card-header {
        font-weight: 600;
        font-size: 1rem;
        border-bottom: none;
        padding: 15px 25px;
        border-radius: 1.25rem 1.25rem 0 0;
        color: #fff;
      }
      .expense-card-header {
        background: linear-gradient(90deg, #ef4444, #b91c1c);
      }
      .table-responsive {
        border-radius: 1rem;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        margin-bottom: 25px;
      }
      .table {
        background-color: #fff;
        border-radius: 1rem;
      }
      .table th {
        background-color: var(--primary-color);
        color: #fff;
        border: none;
        font-weight: 600;
      }
      .table td {
        border: none;
        border-bottom: 1px solid #f3f4f6;
      }
      .table-striped > tbody > tr:nth-of-type(odd) {
        background-color: #f9fafb;
      }
      .table-pengeluaran th {
        background-color: #dc2626;
      } /* Warna merah untuk pengeluaran */
      .btn {
        border-radius: 0.75rem;
        font-weight: 600;
        padding: 0.6rem 1.25rem;
        transition: all 0.2s;
      }
      .btn-light {
        color: var(--primary-color);
        background: #e5e7eb;
        border: none;
      }
      .form-control {
        border-radius: 0.75rem;
      }
      .form-floating {
        margin-bottom: 15px;
      }
    </style>
    <script>
    // 1. Cek apakah ada data username di LocalStorage
    const user = localStorage.getItem("username");

    // 2. Kalau GAK ADA, langsung tendang balik ke login.html
    if (!user) {
        window.location.href = "login.html";
    }
</script>
  </head>
  <body>
    <div class="container">
      <div class="mb-4">
        <a href="index.html" class="btn btn-light mb-3">
          ‚Üê Kembali ke Dashboard
        </a>
        <h1>üí∏ Detail & Tambah Pengeluaran Harian</h1>
        <p class="text-muted">
          Daftar pengeluaran harian dan form untuk menambahkan pengeluaran baru.
        </p>
      </div>

      <!-- FORM TAMBAH PENGELUARAN -->
      <div class="card mb-4">
        <div class="card-header expense-card-header">Tambah Pengeluaran</div>
        <div class="card-body">
          <form id="pengeluaranForm">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="tanggal" class="form-label">Tanggal</label>
                <input type="date" class="form-control" id="tanggal" required />
              </div>
              <div class="col-md-5">
                <label for="keterangan" class="form-label">Keterangan</label>
                <input
                  type="text"
                  class="form-control"
                  id="keterangan"
                  placeholder="Contoh: Sabun cuci motor"
                  required
                />
              </div>
              <div class="col-md-3">
                <label for="jumlah" class="form-label">Jumlah</label>
                <input
                  type="number"
                  class="form-control"
                  id="jumlah"
                  placeholder="Rp"
                  required
                  min="0"
                />
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">
                  Tambah
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- TABEL PENGELUARAN -->
      <div class="card mb-4">
        <div class="card-header expense-card-header">
          Daftar Pengeluaran
          <button
            onclick="getDetailPengeluaran()"
            class="btn btn-sm btn-light float-end py-1 px-3"
          >
            Refresh Data
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table
              class="table table-bordered table-striped table-pengeluaran align-middle"
            >
              <thead>
                <tr>
                  <th>Tanggal</th>
                  <th>Waktu</th>
                  <th>Keterangan</th>
                  <th class="text-end">Jumlah</th>
                </tr>
              </thead>
              <tbody id="detailPengeluaranTableBody">
                <tr>
                  <td colspan="4" class="text-center text-muted py-3">
                    Memuat data...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="totalPengeluaranSummary" class="text-end fw-bold mt-3 fs-5">
            Total Pengeluaran Hari Ini: <span id="totalJumlah">Rp 0</span>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE_URL = "http://localhost:5000/api";

      const formatRupiah = (number) =>
        new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(number);

      async function handleFetch(endpoint, method = "GET", data = null) {
        const url = `${API_BASE_URL}/${endpoint}`;
        const options = {
          method,
          headers: { "Content-Type": "application/json" },
        };
        if (data) options.body = JSON.stringify(data);
        try {
          const res = await fetch(url, options);
          const result = await res.json();
          if (res.ok) return result;
          else throw { status: res.status, data: result };
        } catch (err) {
          if (!err.status)
            throw { status: 0, data: { message: "NETWORK ERROR" } };
          throw err;
        }
      }

      // Ambil detail pengeluaran
      async function getDetailPengeluaran() {
        const tableBody = document.getElementById("detailPengeluaranTableBody");
        const totalJumlahEl = document.getElementById("totalJumlah");

        tableBody.innerHTML =
          '<tr><td colspan="4" class="text-center py-3">Memuat data pengeluaran...</td></tr>';
        totalJumlahEl.textContent = "Memuat...";

        try {
          const result = await handleFetch("Laporan/pengeluaran-harian", "GET");
          const pengeluaran = result.pengeluaran || [];
          const totalPengeluaran = result.totalPengeluaranHariIni || 0;

          if (pengeluaran.length === 0) {
            tableBody.innerHTML =
              '<tr><td colspan="4" class="text-center text-muted py-3">Belum ada catatan pengeluaran.</td></tr>';
            totalJumlahEl.textContent = formatRupiah(0);
            return;
          }

          tableBody.innerHTML = pengeluaran
            .map((item) => {
              const dateObj = new Date(item.tanggal);
              const date = dateObj.toLocaleDateString("id-ID", {
                day: "2-digit",
                month: "short",
                year: "numeric",
              });
              const time = dateObj.toLocaleTimeString("id-ID", {
                hour: "2-digit",
                minute: "2-digit",
              });
              return `
                            <tr>
                                <td class="small fw-bold">${date}</td>
                                <td class="small text-muted">${time}</td>
                                <td>${item.keterangan}</td>
                                <td class="text-end text-danger fw-bold">${formatRupiah(
                                  item.jumlah
                                )}</td>
                            </tr>
                        `;
            })
            .join("");

          totalJumlahEl.textContent = formatRupiah(totalPengeluaran);
        } catch (err) {
          console.error("Error fetching detail pengeluaran:", err);
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-3">Gagal memuat detail pengeluaran.</td></tr>`;
          totalJumlahEl.textContent = "ERROR";
        }
      }

      // Tambah pengeluaran baru
      document
        .getElementById("pengeluaranForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const tanggal = document.getElementById("tanggal").value;
          const keterangan = document.getElementById("keterangan").value.trim();
          const jumlah = parseFloat(document.getElementById("jumlah").value);

          if (!tanggal || !keterangan || isNaN(jumlah) || jumlah < 0) {
            alert("Harap isi semua field dengan benar!");
            return;
          }

          try {
            await handleFetch("Laporan/pengeluaran-harian", "POST", {
              tanggal,
              keterangan,
              jumlah,
            });
            alert("Pengeluaran berhasil ditambahkan!");
            document.getElementById("pengeluaranForm").reset();
            getDetailPengeluaran();
          } catch (err) {
            console.error("Error menambah pengeluaran:", err);
            alert("Gagal menambahkan pengeluaran. Cek console untuk detail.");
          }
        });

      document.addEventListener("DOMContentLoaded", getDetailPengeluaran);
    </script>
  </body>
</html>
