<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Input Transaksi - REAZ STEAM MOTOR</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f9fafb;
        padding: 40px;
      }
      .card {
        border-radius: 1.25rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      }
      .card-header {
        font-weight: 600;
        font-size: 1rem;
        color: #fff;
        border-radius: 1.25rem 1.25rem 0 0;
        padding: 15px 25px;
      }
      .transaction-card-header {
        background: linear-gradient(90deg, #10b981, #047857);
      }
      .btn {
        border-radius: 0.75rem;
        font-weight: 600;
      }
      .response-box {
        margin-top: 15px;
        padding: 12px;
        border-radius: 0.75rem;
        min-height: 50px;
        white-space: pre-wrap;
      }
      .response-box.success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
      }
      .response-box.error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
      }

    </style>
    <script>
      // 1. Cek apakah ada data username di LocalStorage
      const user = localStorage.getItem("username");

      // 2. Kalau GAK ADA, langsung tendang balik ke login.html
      if (!user) {
        window.location.href = "login.html";
      }
    </script>
  </head>
  <body>
    <div class="container" style="max-width: 650px">
      <div class="card mb-4">
        <div class="card-header transaction-card-header">
          üßæ Input Transaksi Cuci Motor
        </div>
        <div class="card-body">
          <form id="transaksiForm" class="row g-3">
            <div class="col-md-6">
              <label for="motorSelect" class="form-label fw-bold small"
                >Pilih Motor:</label
              >
              <select id="motorSelect" class="form-select" required>
                <option value="">Memuat data motor...</option>
              </select>
            </div>

            <div class="col-md-6">
              <label for="karyawanSelect" class="form-label fw-bold small"
                >Pilih Karyawan:</label
              >
              <select id="karyawanSelect" class="form-select" required>
                <option value="">Memuat data karyawan...</option>
              </select>
            </div>

            <div class="col-md-6">
              <label for="layanan" class="form-label fw-bold small"
                >Layanan:</label
              >
              <input
                type="text"
                id="layanan"
                class="form-control"
                value="Cuci Motor"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label for="total" class="form-label fw-bold small"
                >Total Harga (Rp):</label
              >
              <input
                type="text"
                id="total"
                class="form-control"
                placeholder="Akan otomatis terisi"
                readonly
              />
            </div>

            <div class="col-12 mt-3">
              <button type="submit" class="btn btn-success w-100 py-2">
                üíæ Simpan Transaksi
              </button>
            </div>
          </form>

          <div id="transaksiResponse" class="response-box">
            Siap menerima input transaksi...
          </div>
        </div>
      </div>
    </div>

    <script src="config.js"></script> <script>
    // 1. Ambil URL secara dinamis dari config.js
    const BASE_URL = window.CONFIG ? window.CONFIG.API_BASE_URL : "http://localhost:5127/api";
    const API_BASE_URL = BASE_URL;

    const formatRupiah = (angka) =>
        new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0,
        }).format(angka);

    // 2. Load data motor (Mengambil tarif & kategori dari DB)
    async function loadMotor() {
        const select = document.getElementById("motorSelect");
        select.innerHTML = `<option value="">Memuat data motor...</option>`;
        try {
            const res = await fetch(`${API_BASE_URL}/motor`);
            if (!res.ok) throw new Error("Gagal ambil data motor");
            const data = await res.json();
            
            select.innerHTML = `<option value="">Pilih Kategori Motor</option>`;
            data.forEach((m) => {
                const opt = document.createElement("option");
                opt.value = m.id;
                opt.dataset.tarif = m.tarif || 0;
                opt.dataset.kategori = m.kategori;
                opt.textContent = `Motor ${m.kategori} - ${formatRupiah(m.tarif)}`;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error(err);
            select.innerHTML = `<option value="">Gagal muat data. Cek API!</option>`;
        }
    }

    // 3. Load data karyawan (Siapa yang nyuci?)
    async function loadKaryawan() {
        const select = document.getElementById("karyawanSelect");
        select.innerHTML = `<option value="">Memuat data karyawan...</option>`;
        try {
            const res = await fetch(`${API_BASE_URL}/karyawan`);
            if (!res.ok) throw new Error("Gagal ambil data karyawan");
            const data = await res.json();
            
            select.innerHTML = `<option value="">Pilih Karyawan</option>`;
            data.forEach((k) => {
                const opt = document.createElement("option");
                opt.value = k.id;
                opt.textContent = `${k.nama} (${k.posisi || 'Operator'})`;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error(err);
            select.innerHTML = `<option value="">Gagal muat data</option>`;
        }
    }

    // Auto update total harga saat motor dipilih
    document.getElementById("motorSelect").addEventListener("change", (e) => {
        const selected = e.target.options[e.target.selectedIndex];
        const harga = parseInt(selected.dataset.tarif || 0);
        // Tampilkan harga di input readonly "total"
        document.getElementById("total").value = harga ? formatRupiah(harga) : "";
    });

    // 4. Submit transaksi ke database
    document.getElementById("transaksiForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const motorSelect = document.getElementById("motorSelect");
        const karyawanSelect = document.getElementById("karyawanSelect");
        const btnSubmit = e.target.querySelector('button[type="submit"]');

        const motorId = parseInt(motorSelect.value);
        const karyawanId = parseInt(karyawanSelect.value);
        const total = parseInt(motorSelect.options[motorSelect.selectedIndex].dataset.tarif || 0);
        const layanan = document.getElementById("layanan").value;

        if(!motorId || !karyawanId) {
            alert("Pilih Motor dan Karyawan dulu, bro!");
            return;
        }

        const data = { motorId, karyawanId, total, layanan };
        const respEl = document.getElementById("transaksiResponse");
        
        try {
            btnSubmit.disabled = true;
            respEl.className = "alert alert-info mt-3 d-block"; // Pake class Bootstrap biar rapi
            respEl.textContent = "‚è≥ Menyimpan transaksi ke cloud...";

            const res = await fetch(`${API_BASE_URL}/transaksi`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });
            
            const result = await res.json();
            if (!res.ok) throw result;

            respEl.className = "alert alert-success mt-3 d-block";
            respEl.innerHTML = `
                <strong>‚úÖ Berhasil!</strong><br>
                Layanan: ${result.layanan}<br>
                Petugas: ${result.karyawanTerkait?.nama || 'Terdaftar'}<br>
                Biaya: ${formatRupiah(result.total)}
            `;
            
            e.target.reset(); // Kosongkan form setelah sukses
        } catch (err) {
            respEl.className = "alert alert-danger mt-3 d-block";
            respEl.textContent = "‚ùå Gagal: " + (err.message || "Pastikan server aktif");
        } finally {
            btnSubmit.disabled = false;
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        loadMotor();
        loadKaryawan();
    });
</script>
  </body>
</html>
