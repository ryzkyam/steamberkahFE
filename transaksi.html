<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Input Transaksi - REAZ STEAM MOTOR</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f9fafb;
        padding: 40px;
      }
      .card {
        border-radius: 1.25rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      }
      .card-header {
        font-weight: 600;
        font-size: 1rem;
        color: #fff;
        border-radius: 1.25rem 1.25rem 0 0;
        padding: 15px 25px;
      }
      .transaction-card-header {
        background: linear-gradient(90deg, #10b981, #047857);
      }
      .btn {
        border-radius: 0.75rem;
        font-weight: 600;
      }
      .response-box {
        margin-top: 15px;
        padding: 12px;
        border-radius: 0.75rem;
        min-height: 50px;
        white-space: pre-wrap;
      }
      .response-box.success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
      }
      .response-box.error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
      }
    </style>
    <script>
      // 1. Cek apakah ada data username di LocalStorage
      const user = localStorage.getItem("username");

      // 2. Kalau GAK ADA, langsung tendang balik ke login.html
      if (!user) {
        window.location.href = "login.html";
      }
    </script>
  </head>
  <body>
    <div class="container" style="max-width: 650px">
      <div class="card mb-4">
        <div class="card-header transaction-card-header">
          ðŸ§¾ Input Transaksi Cuci Motor
        </div>
        <div class="card-body">
          <form id="transaksiForm" class="row g-3">
            <div class="col-md-6">
              <label for="motorSelect" class="form-label fw-bold small"
                >Pilih Motor:</label
              >
              <select id="motorSelect" class="form-select" required>
                <option value="">Memuat data motor...</option>
              </select>
            </div>

            <div class="col-md-6">
              <label for="karyawanSelect" class="form-label fw-bold small"
                >Pilih Karyawan:</label
              >
              <select id="karyawanSelect" class="form-select" required>
                <option value="">Memuat data karyawan...</option>
              </select>
            </div>

            <div class="col-md-6">
              <label for="layanan" class="form-label fw-bold small"
                >Layanan:</label
              >
              <input
                type="text"
                id="layanan"
                class="form-control"
                value="Cuci Motor"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label for="total" class="form-label fw-bold small"
                >Total Harga (Rp):</label
              >
              <input
                type="text"
                id="total"
                class="form-control"
                placeholder="Akan otomatis terisi"
                readonly
              />
            </div>

            <div class="col-12 mt-3">
              <button type="submit" class="btn btn-success w-100 py-2">
                ðŸ’¾ Simpan Transaksi
              </button>
            </div>
          </form>

          <div id="transaksiResponse" class="response-box">
            Siap menerima input transaksi...
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:5000/api";

      const formatRupiah = (angka) =>
        new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(angka);

      // Load data motor
      async function loadMotor() {
        const select = document.getElementById("motorSelect");
        select.innerHTML = `<option value="">Memuat data motor...</option>`;
        try {
          const res = await fetch(`${API_BASE_URL}/motor`);
          const data = await res.json();
          select.innerHTML = `<option value="">Pilih Motor</option>`;
          data.forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m.id;
            opt.dataset.tarif = m.tarif || 0;
            opt.dataset.kategori = m.kategori;
            opt.textContent = `Motor Kategori ${m.kategori} - ${formatRupiah(
              m.tarif
            )}`;
            select.appendChild(opt);
          });
        } catch (err) {
          console.error("Gagal memuat motor:", err);
          select.innerHTML = `<option value="">Gagal memuat data</option>`;
        }
      }

      // Load data karyawan
      async function loadKaryawan() {
        const select = document.getElementById("karyawanSelect");
        select.innerHTML = `<option value="">Memuat data karyawan...</option>`;
        try {
          const res = await fetch(`${API_BASE_URL}/karyawan`);
          const data = await res.json();
          select.innerHTML = `<option value="">Pilih Karyawan</option>`;
          data.forEach((k) => {
            const opt = document.createElement("option");
            opt.value = k.id;
            opt.textContent = `${k.nama} (${k.posisi})`;
            select.appendChild(opt);
          });
        } catch (err) {
          console.error("Gagal memuat karyawan:", err);
          select.innerHTML = `<option value="">Gagal memuat data</option>`;
        }
      }

      // Auto update total harga saat motor dipilih
      document.getElementById("motorSelect").addEventListener("change", (e) => {
        const selected = e.target.options[e.target.selectedIndex];
        const harga = parseInt(selected.dataset.tarif || 0);
        document.getElementById("total").value = harga
          ? formatRupiah(harga)
          : "";
      });

      // Submit transaksi
      document
        .getElementById("transaksiForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const motorSelect = document.getElementById("motorSelect");
          const karyawanSelect = document.getElementById("karyawanSelect");

          const motorId = parseInt(motorSelect.value);
          const karyawanId = parseInt(karyawanSelect.value);
          const total = parseInt(
            motorSelect.options[motorSelect.selectedIndex].dataset.tarif || 0
          );
          const layanan = document.getElementById("layanan").value;

          const data = { motorId, karyawanId, total, layanan };

          const respEl = document.getElementById("transaksiResponse");
          respEl.className = "response-box";
          respEl.textContent = "â³ Menyimpan transaksi...";

          try {
            const res = await fetch(`${API_BASE_URL}/transaksi`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await res.json();

            if (!res.ok) throw result;

            respEl.classList.add("success");
            respEl.textContent = `âœ… Transaksi Berhasil!\nMotor ID: ${
              result.motorId
            }\nKaryawan: ${result.karyawanTerkait?.nama}\nTotal: ${formatRupiah(
              result.total
            )}`;
          } catch (err) {
            respEl.classList.add("error");
            respEl.textContent = err.message || "âŒ Gagal menyimpan transaksi.";
          }
        });

      // Jalankan saat halaman siap
      document.addEventListener("DOMContentLoaded", () => {
        loadMotor();
        loadKaryawan();
      });
    </script>
  </body>
</html>
